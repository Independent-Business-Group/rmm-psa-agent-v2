name: Build Agent v2

on:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build Agent v2 for Multiple Platforms
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: |
          npm install
          npm install -g pkg

      - name: Prepare dist directory
        run: |
          # Save install.bat from repository before cleaning dist
          cp dist/install.bat /tmp/install.bat 2>/dev/null || echo "No install.bat in dist/"
          # Clean and recreate dist
          rm -rf dist/*
          mkdir -p dist/helpers
          # Restore install.bat for packaging
          cp /tmp/install.bat dist/install.bat 2>/dev/null || echo "Using package.js generated install.bat"

      - name: Build core agent
        run: |
          echo "Building core agent for all platforms..."
          pkg lib/start.js \
            --targets node18-win-x64,node18-linux-x64,node18-macos-x64 \
            --output dist/EverydayTechAgent-v2

      - name: Build helpers
        run: |
          if [ -f scripts/build-helpers.js ]; then
            node scripts/build-helpers.js win32 || echo "Windows helpers build skipped"
            node scripts/build-helpers.js linux || echo "Linux helpers build skipped"
            node scripts/build-helpers.js darwin || echo "macOS helpers build skipped"
          else
            echo "Helper build script not found, skipping"
          fi

      - name: Create distribution packages
        run: |
          # Create deployment package with installer scripts
          cd dist
          mkdir -p deployment

          # Copy Windows deployment files
          if [ -f EverydayTechAgent-v2-win.exe ]; then
            cp EverydayTechAgent-v2-win.exe deployment/
            cp -r helpers deployment/ 2>/dev/null || echo "No helpers to copy"
            cp install.bat deployment/ 2>/dev/null || echo "No install.bat"
            cp install-service.bat deployment/ 2>/dev/null || echo "No install-service.bat"
            cp test.bat deployment/ 2>/dev/null || echo "No test.bat"
            
            # Create deployment zip
            cd deployment
            zip -r ../agent-v2-windows-deployment.zip .
            cd ..
            ls -lh agent-v2-windows-deployment.zip
          fi
          
          # Copy bootstrap installer to root for standalone download
          cp bootstrap-install.bat . 2>/dev/null || echo "No bootstrap installer"

      - name: List build artifacts
        run: |
          echo "Core executables:"
          ls -lh dist/EverydayTechAgent-v2*
          echo ""
          echo "Helpers:"
          ls -lh dist/helpers/ || true
          echo ""
          echo "Packages:"
          ls -lh dist/*.zip dist/*.tar.gz 2>/dev/null || true

      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: agent-v2-windows
          path: |
            dist/EverydayTechAgent-v2-win*
            dist/agent-v2-windows-deployment.zip
            dist/bootstrap-install.bat
            dist/helpers/**
          retention-days: 30

      - name: Upload Linux build
        uses: actions/upload-artifact@v4
        with:
          name: agent-v2-linux
          path: |
            dist/EverydayTechAgent-v2-linux*
            dist/helpers/linux/**
          retention-days: 30

      - name: Upload macOS build
        uses: actions/upload-artifact@v4
        with:
          name: agent-v2-macos
          path: |
            dist/EverydayTechAgent-v2-macos*
            dist/helpers/darwin/**
          retention-days: 30

      - name: Upload distribution packages
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: agent-v2-packages
          path: |
            dist/*.zip
            dist/*.tar.gz
          retention-days: 30

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f -ls

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find artifacts -type f \( -name "*.exe" -o -name "*.zip" -o -name "*.tar.gz" \) -exec cp {} release-files/ \;
          echo "Release files:"
          ls -lh release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-files/*
          draft: false
          prerelease: false
          generate_release_notes: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
